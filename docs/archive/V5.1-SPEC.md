# V5.1 Specification — Quality of Life Release

**Focus:** Polish, cleanup, bug fixes, Rust integration, project wizard.

**Prerequisite:** V5 King tmux implementation complete.

---

## 1. Documentation Cleanup

### Current State
Multiple overlapping/outdated spec files with version-based naming.

### Target: 5 Files in Root
| File | Purpose |
|------|---------|
| `README.md` | Quick start, installation, overview |
| `ARCHITECTURE.md` | How it works (current state) |
| `CONTRIBUTING.md` | Dev setup, testing, code style |
| `CHANGELOG.md` | Version history |
| `TODO.md` | Active task tracking |

### Tasks
- [ ] Consolidate specs into 5 files above
- [ ] Move historical specs to `docs/archive/`:
  - `V4-IMPLEMENTATION.md`
  - `V5-IMPLEMENTATION.md`
  - `V4-API-ROUTES.md`
  - `V4-RUST-CONTRACTS.md`
  - `PERSONAS-SPEC.md`
  - `TOKEN-RESEARCH.md`
  - `MISSIONCONTROL-ARCHITECTURE-SPEC.md`
- [ ] Remove `web/README.md` Vite boilerplate (or replace with real content)
- [ ] Update `README.md` with accurate v5 architecture diagram
- [ ] Ensure `ARCHITECTURE.md` reflects current state (King + tmux + Rust core)

---

## 2. Repository Cleanup

### Naming Cleanup

**Current Mess:**
| File | Problem |
|------|---------|
| `orchestrator/api/v5.go` | Version in filename |
| `orchestrator/api/v4.go` | Version in filename |
| `V4-*.md`, `V5-*.md` | Version prefixes |
| `MISSIONCONTROL-ARCHITECTURE-SPEC.md` | Redundant naming |

**Renames:**
- [ ] `orchestrator/api/v5.go` → `orchestrator/api/king.go`
- [ ] `orchestrator/api/v4.go` → `orchestrator/api/mission.go`
- [ ] Any other `v4`/`v5` prefixed code files → sensible names

### Target Directory Structure
```
/
├── cmd/mc/                  # mc CLI
├── orchestrator/            # Go bridge
│   ├── api/
│   │   ├── routes.go        # Route registration
│   │   ├── king.go          # King endpoints
│   │   ├── agents.go        # Agent endpoints
│   │   ├── zones.go         # Zone endpoints
│   │   └── projects.go      # Project/wizard endpoints (new)
│   ├── bridge/
│   │   └── king.go          # King tmux manager
│   ├── core/
│   │   └── client.go        # Rust subprocess wrapper (new)
│   ├── manager/
│   └── ws/
├── core/                    # Rust core
│   ├── workflow/
│   ├── knowledge/
│   ├── ffi/
│   └── README.md            # Rust API docs
├── web/                     # React UI
├── agents/                  # Python agents (educational)
├── docs/
│   ├── archive/             # Old specs
│   └── api/                 # API reference
├── scripts/                 # Dev scripts
├── README.md
├── ARCHITECTURE.md
├── CONTRIBUTING.md
├── CHANGELOG.md
├── TODO.md
└── Makefile
```

### Other Cleanup Tasks
- [ ] Audit for dead code / unused files
- [ ] Ensure `.gitignore` covers: `dist/`, `target/`, `node_modules/`, `.mission/`
- [ ] Remove any accidentally committed build artifacts
- [ ] Add `CODEOWNERS` for GitHub (optional)

---

## 3. Testing Improvements

### Current State
| Type | Count |
|------|-------|
| Go unit tests | 29 |
| React unit tests | 52 |
| Rust tests | 0 |
| Integration tests | 0 |
| E2E tests | 0 |

### Rust Tests
- [ ] `core/workflow/` — state machine transitions
- [ ] `core/knowledge/` — token counting accuracy
- [ ] Handoff JSON validation
- [ ] Gate criteria checking
- [ ] `cargo test` passes all

### Go Integration Tests
- [ ] King tmux session lifecycle (start → message → response → stop)
- [ ] WebSocket connection + event flow
- [ ] API endpoints with mocked Claude
- [ ] Rust core subprocess calls (`mc-core tokens`, `mc-core validate`)

### React Tests (additions)
- [ ] Project wizard component
- [ ] Multi-project switching
- [ ] Matrix toggle interactions

### E2E Tests (Playwright)
- [ ] Project wizard flow end-to-end
- [ ] King Mode: send message, receive response
- [ ] Agent spawning + count updates
- [ ] Zone management CRUD
- [ ] Token usage displays correctly
- [ ] WebSocket reconnection

### Test Infrastructure
- [ ] `make test` — runs Go + React + Rust
- [ ] `make test-rust` — Rust only (`cargo test`)
- [ ] `make test-go` — Go only (`go test ./...`)
- [ ] `make test-web` — React only (`npm test`)
- [ ] `make test-integration` — Go integration tests
- [ ] `make test-e2e` — Playwright
- [ ] GitHub Actions CI workflow for PRs

---

## 4. Startup Simplification

### Current Pain
User must run in separate terminals:
```bash
# Terminal 1
cd web && npm run dev

# Terminal 2
cd orchestrator && go run .
```

### Makefile Commands
- [ ] `make dev` — starts vite + orchestrator together (single command)
- [ ] `make dev-ui` — vite only
- [ ] `make dev-api` — orchestrator only
- [ ] `make build` — production build (Go + Rust + React)
- [ ] `make install` — install binaries to `/usr/local/bin`
- [ ] `make clean` — remove build artifacts

### Single Binary Distribution
- [ ] `mc serve` command — starts orchestrator + serves built React UI
- [ ] Embed built `web/dist/` in Go binary using `embed` package
- [ ] Single binary contains everything

### Homebrew
- [ ] Create `homebrew-tap` repo (`DarlingtonDeveloper/homebrew-tap`)
- [ ] Formula downloads release binary
- [ ] Installation:
  ```bash
  brew tap DarlingtonDeveloper/tap
  brew install mission-control
  ```
- [ ] Document in README

---

## 5. Project Setup Wizard

### Behavior
- Opens automatically if no project selected
- Multi-project support (sidebar shows project list)
- Directory chosen upfront (agents never ask for path)
- Conversational feel, no LLM required
- Typing indicator (300ms delay) for polish

### Step 1: Project Setup
```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  ⏺ Let's set up your project.                              │
│                                                             │
│    Where?                                                   │
│    [/Users/mike/projects/myapp________] [Browse]            │
│                                                             │
│    Who's it for?                                            │
│    [Personal]  [Customers]                                  │
│                                                             │
│    ☑ Initialize git                                         │
│    ☑ Enable King (recommended)                              │
│                                                             │
│    [Continue →]                                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 2: Workflow Matrix
```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  ⏺ Here's your workflow. Click any cell to toggle.         │
│                                                             │
│  ┌────────────┬──────────┬─────────┬─────────┬────────┐    │
│  │            │ Frontend │ Backend │ Database│ Shared │    │
│  ├────────────┼──────────┼─────────┼─────────┼────────┤    │
│  │ IDEA       │          │         │         │        │    │
│  │ Researcher │    ✓     │    ✓    │    ✓    │   ✓    │    │
│  ├────────────┼──────────┼─────────┼─────────┼────────┤    │
│  │ DESIGN     │          │         │         │        │    │
│  │ Designer   │    ✓     │         │         │        │    │
│  │ Architect  │          │    ✓    │    ✓    │        │    │
│  ├────────────┼──────────┼─────────┼─────────┼────────┤    │
│  │ IMPLEMENT  │          │         │         │        │    │
│  │ Developer  │    ✓     │    ✓    │    ✓    │   ✓    │    │
│  │ Debugger   │    ✓     │    ✓    │    ✓    │        │    │
│  ├────────────┼──────────┼─────────┼─────────┼────────┤    │
│  │ VERIFY     │          │         │         │        │    │
│  │ Reviewer   │    ✓     │    ✓    │         │        │    │
│  │ Security   │    ○     │    ○    │    ○    │        │    │
│  │ Tester     │    ✓     │    ✓    │         │        │    │
│  │ QA         │    ○     │    ○    │         │        │    │
│  ├────────────┼──────────┼─────────┼─────────┼────────┤    │
│  │ DOCUMENT   │          │         │         │        │    │
│  │ Docs       │    ✓     │    ✓    │         │   ✓    │    │
│  ├────────────┼──────────┼─────────┼─────────┼────────┤    │
│  │ RELEASE    │          │         │         │        │    │
│  │ DevOps     │    ○     │    ○    │         │        │    │
│  └────────────┴──────────┴─────────┴─────────┴────────┘    │
│                                                             │
│  ✓ = enabled   ○ = disabled                                 │
│                                                             │
│    [← Back]  [Create Project]                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Matrix Interactions
| Action | Result |
|--------|--------|
| Click cell | Toggle ✓/○ |
| Click phase header (IDEA, DESIGN, etc.) | Toggle entire phase |
| Click zone header (Frontend, Backend, etc.) | Toggle entire zone |
| Hover cell | Tooltip with persona description |

### Smart Defaults
| Audience | Pre-disabled |
|----------|--------------|
| Personal | Security, QA, DevOps |
| Customers | None (all enabled) |

### Smart Behaviors (No LLM)
| Condition | Behavior |
|-----------|----------|
| Path has `.git/` | Uncheck + disable "Initialize git" |
| Path has `.mission/` | "Project exists. Open it?" → skip wizard |
| Path doesn't exist | Create folder on submit |
| All personas in phase off | Phase header shows ○ |
| Some personas in phase off | Phase header shows ◐ |

### Implementation Tasks
- [ ] `ProjectWizard` component with step state machine
- [ ] `WorkflowMatrix` component with toggle logic
- [ ] Typing indicator component (300ms delay)
- [ ] `POST /api/projects` — calls `mc init` subprocess
- [ ] `GET /api/projects` — reads from `~/.mission-control/config.json`
- [ ] `DELETE /api/projects/:id` — removes from list (not disk)
- [ ] Sidebar project list with switch capability
- [ ] `mc init` CLI accepts flags:
  ```bash
  mc init --path /foo --git --king --audience personal --config config.json
  ```
- [ ] Wizard passes matrix config as JSON file to `mc init`

### Future: Mobile Compact View (v6+)
Collapsible phase list instead of matrix. **Not in v5.1 scope.**

---

## 6. Configuration & Storage

### Decision: Global Config Location
**Path:** `~/.mission-control/config.json`

```json
{
  "projects": [
    {
      "path": "/Users/mike/projects/myapp",
      "name": "myapp",
      "lastOpened": "2026-01-19T10:00:00Z"
    },
    {
      "path": "/Users/mike/projects/other",
      "name": "other", 
      "lastOpened": "2026-01-18T15:00:00Z"
    }
  ],
  "lastProject": "/Users/mike/projects/myapp",
  "preferences": {
    "theme": "dark"
  }
}
```

### Why
- Standard pattern (VS Code, JetBrains, Gastown)
- Fast lookup, no filesystem scanning
- Tracks recent projects for sidebar ordering
- Global preferences have a home
- `mc` CLI can read this too

### Tasks
- [ ] Create `~/.mission-control/` on first run
- [ ] `mc` CLI reads/writes config
- [ ] Orchestrator reads/writes config
- [ ] Add project to list when created via wizard
- [ ] Update `lastOpened` when project opened
- [ ] Sort sidebar by `lastOpened` descending

---

## 7. Bug Fix: Rust Core Not Integrated

### Problem
Rust `core/` built but never called. Go does its own parsing.

### Likely Symptoms
- Token usage shows 0 or wrong
- Agent count not updating
- No handoff validation

### Decision: Binary Location
**Path:** `/usr/local/bin/mc-core` (alongside `mc`)

Go lookup logic:
```go
// Try PATH first
path, err := exec.LookPath("mc-core")
if err != nil {
    // Fallback: same directory as mc binary
    path = filepath.Join(filepath.Dir(os.Executable()), "mc-core")
}
```

### Integration: Subprocess Approach

Create `orchestrator/core/client.go`:
```go
package core

// CountTokens counts tokens in text using mc-core
func CountTokens(text string) (int, error)

// ValidateHandoff validates a handoff JSON file
func ValidateHandoff(path string) (valid bool, errors []string, err error)

// CheckGate checks if a phase gate is ready
func CheckGate(phase string, missionDir string) (ready bool, err error)
```

### mc-core CLI Commands
```bash
# Token counting
mc-core tokens "text to count"
# → {"count": 150}

# Handoff validation
mc-core validate handoff /path/to/handoff.json
# → {"valid": true} or {"valid": false, "errors": ["..."]}

# Gate check
mc-core gate check idea --mission-dir .mission/
# → {"ready": true, "criteria": [...]}
```

### Tasks
- [ ] Verify `mc-core` binary builds with `make build`
- [ ] Implement CLI commands in Rust (if not already)
- [ ] Create `orchestrator/core/client.go` wrapper
- [ ] Replace inline Go parsing with `core.CountTokens()` etc.
- [ ] Update `make install` to install both `mc` and `mc-core`
- [ ] Update `make build` to compile Rust before Go

---

## 8. Bug Fix: Token Usage Display

### Current Flow (Broken)
```
Claude response → Go parses (badly?) → WebSocket event → UI shows ???
```

### Fixed Flow
```
Claude output → mc-core tokens → Go emits event → UI displays
```

### Tasks
- [ ] After King response, pipe text through `mc-core tokens`
- [ ] Emit `token_usage` WebSocket event:
  ```json
  {"type": "token_usage", "data": {"count": 150, "total": 4500}}
  ```
- [ ] UI: update store from event
- [ ] UI: display in header/status bar

---

## 9. Bug Fix: Agent Count

### Tasks
- [ ] Verify `agent_spawned` event emits on spawn
- [ ] Verify `agent_stopped` event emits on kill
- [ ] UI: listen to events, update `agents` array in store
- [ ] Playwright test: spawn agent → verify count increments

---

## 10. UI Polish

### Bug Fixes
- [ ] Token usage displays (see §8)
- [ ] Agent count updates (see §9)

### Loading/Error/Empty States
- [ ] Loading spinner while waiting for King response
- [ ] Error state with retry button (WebSocket disconnect, API error)
- [ ] Empty state: no project selected → show wizard
- [ ] Empty state: no agents → "Spawn your first agent" prompt

### UX Improvements
- [ ] WebSocket connection indicator (green/red dot in header)
- [ ] King conversation persists in localStorage
- [ ] Clear conversation button
- [ ] Copy response to clipboard button
- [ ] Keyboard shortcut hints (tooltips on hover)

### Visual Polish
- [ ] Consistent color palette
- [ ] Agent status indicators (idle/working/error)
- [ ] Typing indicator in King chat

---

## 11. Developer Experience

### Makefile Additions
- [ ] `make lint` — Go (`golangci-lint`) + Rust (`clippy`) + TypeScript (`eslint`)
- [ ] `make fmt` — format all code (`go fmt`, `cargo fmt`, `prettier`)

### Editor Setup
- [ ] `.vscode/settings.json` — format on save, recommended settings
- [ ] `.vscode/extensions.json` — recommended extensions list

### Optional
- [ ] Pre-commit hooks via lefthook or husky

---

## 12. Success Criteria

| # | Criteria | Status |
|---|----------|--------|
| 1 | `make dev` starts everything with one command | TODO |
| 2 | `make test` passes Go + React + Rust tests | TODO |
| 3 | `make test-e2e` passes Playwright tests | TODO |
| 4 | README gets new user running in <5 minutes | TODO |
| 5 | ≤5 markdown files in root | TODO |
| 6 | No version-prefixed filenames (v4, v5) | TODO |
| 7 | Project wizard creates working `.mission/` | TODO |
| 8 | Token usage displays correctly | TODO |
| 9 | Agent count updates in real-time | TODO |
| 10 | Rust core called for token counting + validation | TODO |
| 11 | Multi-project switching works | TODO |
| 12 | `brew install mission-control` works | TODO |
| 13 | Global config at `~/.mission-control/config.json` | TODO |

---

## 13. Implementation Order

| Order | Task | Rationale |
|-------|------|-----------|
| 1 | Rust integration | Likely fixes token + agent bugs |
| 2 | Bug fixes (token, agent count) | Verify after Rust integration |
| 3 | Naming cleanup | Quick win, reduces confusion |
| 4 | Project wizard | Major UX improvement |
| 5 | Startup simplification (`make dev`) | DX improvement |
| 6 | Homebrew | Distribution |
| 7 | Testing (Rust, integration, Playwright) | Quality gate |
| 8 | Documentation cleanup | Consolidate files |
| 9 | UI polish | Final touches |

---

## 14. Out of Scope (Future Versions)

| Item | Version |
|------|---------|
| Mobile responsive UI | v6+ |
| 3D visualization | v6 |
| Multi-model support (Gemini, Codex) | v7+ |
| Persistence/database | v7+ |
| Remote access | v7+ |

---

## 15. Decisions Log

| Question | Decision | Rationale |
|----------|----------|-----------|
| Project storage | `~/.mission-control/config.json` | Standard pattern, fast, supports recent projects |
| mc-core location | `/usr/local/bin/mc-core` | Simple, Homebrew-friendly, alongside `mc` |
| Wizard API | Subprocess call to `mc init` | DRY, single source of truth, easy testing |